<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>すごろくクエスト</title>

<link rel="stylesheet" href="sugoroku.css">
</head>

<body>
<div id="container">
<h1>すごろくクエスト</h1>
<div id="log"></div>
<div id="controls"></div>
<div id="board"></div>
<button onclick="newGame()">NewGame</button>
</div>

<script>
class Field {
    constructor() {
        this.here = 0;   // 現在地
        this.pAct = 0;   // プレイヤーアクション（コマンド選択）
        this.enc = 0;    // エンカウント
        this.dice = 0;   // サイコロ
        this.pHp = 10;   // プレイヤーHP
    }
    async board() {
        log("10マス目に到達してください。\n");
        drawBoard(this.here);                       //drawBoardを呼び出し、flexの初期表示

        while (this.here < 10) {
            await sleep(500);
            log(`現在地は${this.here}マス目です。`);
            log(`プレイヤーのHPは${this.pHp}です。\n`);

            await sleep(300);
            log("コマンドを選択してください（移動 / 休息）");
            await waitCommand(["移動", "休息"]);

            if (this.pAct === 1) {                  // 移動
                this.dice = rand(1, 4);
                this.here += this.dice;
                this.enc = rand(1, 10);
                drawBoard(this.here);                //drawBoardを呼び出し、flexの現在地を更新
                log(`<span style="color: blue;">\n${this.dice}マス移動します。\n</span>`);

                if (this.here >= 10) {
                    await sleep(500);
                    return "goal";
                }
                if (this.enc > 4) {
                    await sleep(300);
                    log("モンスターが現れた！！\n");
                    return "battle";
                }
            } else if (this.pAct === 2) {           // 休息
                if (this.pHp <= 7) {
                log('<span style="color: green;">HPが3回復した！\n</span>');
                    this.pHp += 3;
                }
                else {
                log('<span style="color: green;">HPが全回復した！\n</span>');
                    this.pHp = 10;
                }

                this.enc = rand(1, 10);
                if (this.enc > 7) {
                    await sleep(300);
                    log("モンスターが現れた！！\n");
                    return "battle";
                }
            }
        }
    }
}

class Quest extends Field {
    constructor() {             //初期値の設定
        super();
        this.eHp = 10;          //エネミー（敵）HP
        this.defFlag = false;   //ディフェンスフラグ（防御）
        this.pow = 0;           //力を溜める（防御時）
        this.pAttack = 0;       //プレイヤーの攻撃
        this.eAttack = 0;       //敵の攻撃
    }
    reset(hp) {                 //敵HPを初期化
        this.eHp = hp;
    }

    async start() {             //戦鬪開始時
        log("戦闘を開始します。\n");
        await this.battle();    //battleへ移行
    }
    async battle() {
        while (this.pHp > 0) {
            await sleep(300);
            log(`プレイヤーのHPは${this.pHp}です。`);
            log(`モンスターのHPは${this.eHp}です。\n`);

            await sleep(300);
            log("コマンドを選択してください（攻撃 / 防御）");
            await waitCommand(["攻撃", "防御"]);

            if (this.pAct === 1) this.attack();         //attackへ移行
            else if (this.pAct === 2) this.defense();   //defenseへ移行

            if (this.eHp > 0) {
                await this.eattack();                   //eattackへ移行
            } else {
                break;
            }
        }
        if (this.pHp > 0 && this.eHp <= 0) {
            await sleep(300);
            log('<span style="color: green;">\nプレイヤーの勝利！</span>');
        } else if (this.pHp <= 0 && this.eHp > 0) {
            await sleep(300);
            log('<span style="color: green;">\nプレイヤーは敗れた！</span>');
            log("ゲーム終了");
            gameOver = true;
        }
    }

    attack() {                      //プレイヤーの攻撃
        log('<span style="color: blue;">\nプレイヤーの攻撃!</span>');
        this.pAttack = rand(1, 3);
        if (this.pow <= 0) {
            this.eHp -= this.pAttack;
            log(`モンスターに${this.pAttack}ダメージ　あたえた！\n`);
        } else {
            this.eHp -= (this.pAttack + this.pow);
            log(`モンスターに${this.pAttack + this.pow}ダメージ　あたえた！\n`);
            this.pow = 0;
        }
    }
    defense() {                     //防御を選択
        this.defFlag = true;
        log('<span style="color: blue;">\nプレイヤーは防御しつつ、力を１溜めた！</span>\n');
        this.pow++;
    }

    async eattack() {               //敵の攻撃
        await sleep(300);
        log('<span style="color: red;">モンスターの攻撃!</span>');
        this.eAttack = rand(1, 2);
        await sleep(300);
        if (!this.defFlag) {
            this.pHp -= this.eAttack;
            log(`プレイヤーに${this.eAttack}ダメージ　あたえた！\n`);
        } else {
            this.defFlag = false;
            if (this.eAttack === 2) {
                this.eAttack -= 1;
                this.pHp -= this.eAttack;
                log(`プレイヤーに${this.eAttack}ダメージ　あたえた！\n`);
            } else {
                log("プレイヤーはダメージを受けなかった！\n");
            }
        }
    }
}

// ===== ユーティリティ =====
function rand(min, max) {       //ランダムの簡略化
    return Math.floor(Math.random() * (max - min + 1)) + min;   //小数点以下切り捨て、数値の幅合わせ、最小値から入力
}
function log(msg) {             //ログの表示設定
    const logDiv = document.getElementById("log");  //HTMLのidであるlogを取得し代入
    logDiv.innerHTML += msg + "<br>";               //HTMLを有効にし、新しいメッセージを改行付きで追加
    logDiv.scrollTop = logDiv.scrollHeight;         //スクロール位置を最下部に移動
}
function sleep(ms) {             //処理を一時停止
    return new Promise(res => setTimeout(res, ms)); //オブジェクト作成、ミリ秒待つ（500=0.5s）
}
function waitCommand(labels) {  //ボタン（ラベル）を表示して、クリックを待つ
    return new Promise(resolve => {     //非同期処理のオブジェクト作成（成功resolveか失敗rejectのどちらかを持つ）、
        const controls = document.getElementById("controls");   //HTMLのidであるcontrolsを取得し、代入
        controls.innerHTML = "";                                //前のボタンを消す
        
        labels.forEach((label, idx) => {                        //渡されたラベルの数だけボタンを作成
            const btn = document.createElement("button");       //新しいボタン要素を作成し、代入
            btn.textContent = `${label}`;                       //ボタンに表示する文字をセット
            btn.onclick = () => {                               //ボタンがクリックされた時に実行する処理の定義
                hero.pAct = idx + 1;                            //どのボタンが押されたか番号を記録（1,2...）
                controls.innerHTML = "";                        //ボタンを消す
                resolve();                                      //処理再開
            };
            controls.appendChild(btn);                          //作成したボタンを画面に追加
        });
    });
}
function drawBoard(here) {      //flexの表示設定
    const boardDiv = document.getElementById("board");          //HTMLのidであるboardを取得し代入
    boardDiv.innerHTML = "";                                    //前の盤面を消す
    
    const playerPos = here >= 10 ? 10 : here;                   //もしhereが10以上なら10に固定

    for (let i = 0; i <= 10; i++) {                             //11個のマスを作るループ（1マス目はスタート位置の為）
        const square = document.createElement("div");           //新しいdiv要素（マス）を作成し、代入
        square.classList.add("square");                         //CSS用のクラスsquareを追加。 .squareが適用される
        const img = document.createElement("img");              //新しい<img>要素（画像タグ）を作成し、代入

        if (i === playerPos) {                                       //マスの番号 i がプレイヤーの位置 here と一致した場合
            img.src = "images/yusya.jpg";                       //画像の指定
        }
        else {                                                  //それ以外のマス
            img.src = "images/sogen_01.png";                    //画像の指定
        }
        
        square.appendChild(img);                                //マスの中に画像を追加
        boardDiv.appendChild(square);                           //作ったマスをboardDivの子要素として追加し、画面（DOM）表示
    }
}

// ===== ゲーム進行 =====
let hero;
let gameOver = false;

async function gameLoop() {
    while (hero.here < 10 && !gameOver) {
        const result = await hero.board();
        if (result === "goal" || gameOver) break;
        if (result === "battle") {
            await hero.start();     //start()を呼び出し、戦闘開始
            hero.reset(10);         //reset()を呼び出し、敵HPを10に戻す
        }
    }
    if (!gameOver && hero.here >= 10) {
        log('<span style="color: blue;">\n目的地に到達しました！</span>\n');
        log("ゲーム終了");
    }
}

function newGame() {
    document.getElementById("log").textContent = "";
    document.getElementById("controls").innerHTML = "";
    hero = new Quest();
    gameOver = false;
    gameLoop();
}

// 初回スタート
newGame();
</script>
</body>
</html>
